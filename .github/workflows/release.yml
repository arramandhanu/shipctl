name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "## What's Changed" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          if [[ -n "$PREV_TAG" ]]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> RELEASE_NOTES.md
          else
            git log --pretty=format:"- %s" >> RELEASE_NOTES.md
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ steps.version.outputs.VERSION }}" >> RELEASE_NOTES.md

      - name: Create release archive
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          ARCHIVE_NAME="shipctl-${VERSION}"
          
          mkdir -p dist
          
          # Create tarball
          tar --exclude='.git' \
              --exclude='dist' \
              --exclude='.env' \
              --exclude='config/services.env' \
              -czvf "dist/${ARCHIVE_NAME}.tar.gz" \
              --transform "s,^,${ARCHIVE_NAME}/," \
              .
          
          # Create zip
          zip -r "dist/${ARCHIVE_NAME}.zip" . \
              -x ".git/*" \
              -x "dist/*" \
              -x ".env" \
              -x "config/services.env"
          
          # Generate checksums
          cd dist
          sha256sum "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}.zip" > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-formula:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version and SHA
        id: info
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"
          
          # Download and calculate SHA256
          curl -sL "$URL" -o release.tar.gz
          SHA256=$(sha256sum release.tar.gz | awk '{print $1}')
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT
          echo "URL=${URL}" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cat > Formula/shipctl.rb << EOF
          class Shipctl < Formula
            desc "Professional Docker deployment automation tool"
            homepage "https://github.com/${{ github.repository }}"
            url "${{ steps.info.outputs.URL }}"
            sha256 "${{ steps.info.outputs.SHA256 }}"
            license "MIT"
            version "${{ steps.info.outputs.VERSION }}"

            depends_on "bash"
            depends_on "git"

            def install
              prefix.install Dir["*"]
              bin.install_symlink prefix/"shipctl" => "shipctl"
              bash_completion.install "completions/shipctl.bash" => "shipctl"
            end

            def caveats
              <<~EOS
                Run 'shipctl init' in your project directory to get started.
              EOS
            end

            test do
              system "#{bin}/shipctl", "--version"
            end
          end
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update formula to v${{ steps.info.outputs.VERSION }}"
          title: "chore: update Homebrew formula to v${{ steps.info.outputs.VERSION }}"
          body: |
            Automated formula update for release v${{ steps.info.outputs.VERSION }}
            
            - Updated URL to new release
            - Updated SHA256 checksum
          branch: chore/update-formula-${{ steps.info.outputs.VERSION }}
          base: main
