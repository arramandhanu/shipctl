# shipctl - Bitbucket Pipelines
#
# This pipeline deploys services using shipctl.
# Configure your services in deploy.env or config/services.env before use.
#
# Required Repository Variables (Settings > Pipelines > Repository Variables):
#   DOCKERHUB_USERNAME  - DockerHub username
#   DOCKERHUB_PASSWORD  - DockerHub access token (secured)
#   SSH_PRIVATE_KEY     - SSH private key (secured)
#   REMOTE_HOST         - Deployment server IP/hostname
#   REMOTE_USER         - SSH user for deployment

image: docker:24-dind

definitions:
  services:
    docker:
      memory: 2048

  steps:
    #--------------------------------------------------------------------------
    # Reusable deploy step
    #--------------------------------------------------------------------------
    - step: &deploy-step
        name: Deploy Service
        services:
          - docker
        caches:
          - docker
        script:
          # Install dependencies
          - apk add --no-cache openssh-client bash git curl
          
          # Setup SSH
          - mkdir -p ~/.ssh
          - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          - chmod 600 ~/.ssh/deploy_key
          - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Docker login
          - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          
          # Make deploy script executable
          - chmod +x ./shipctl
          
          # Export SSH key path
          - export SSH_KEY=~/.ssh/deploy_key
          
          # Run deployment
          - |
            if [ -n "$SERVICE" ]; then
              ./shipctl ${SERVICE} --yes --env ${ENVIRONMENT:-production}
            else
              ./shipctl --all --yes --env ${ENVIRONMENT:-production}
            fi

    #--------------------------------------------------------------------------
    # Validate step
    #--------------------------------------------------------------------------
    - step: &validate-step
        name: Validate Configuration
        script:
          - apk add --no-cache bash
          - chmod +x ./shipctl
          - ./shipctl --list || echo "Run: shipctl init"

pipelines:
  #----------------------------------------------------------------------------
  # Custom Pipelines (Manual Trigger from Bitbucket UI)
  #----------------------------------------------------------------------------
  custom:
    # Deploy a specific service
    deploy-service:
      - variables:
          - name: SERVICE
            default: ""
          - name: ENVIRONMENT
            default: "production"
            allowed-values:
              - staging
              - production
      - step:
          <<: *deploy-step
          name: Deploy ${SERVICE:-all services}
          deployment: ${ENVIRONMENT}

    # Deploy all services
    deploy-all:
      - variables:
          - name: ENVIRONMENT
            default: "production"
            allowed-values:
              - staging
              - production
      - step:
          <<: *deploy-step
          name: Deploy All Services
          deployment: ${ENVIRONMENT}
          script:
            - apk add --no-cache openssh-client bash git curl
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./shipctl
            - export SSH_KEY=~/.ssh/deploy_key
            - ./shipctl --all --yes --env ${ENVIRONMENT}

    # Dry run for testing
    dry-run:
      - step:
          name: Dry Run Test
          services:
            - docker
          script:
            - apk add --no-cache bash git
            - chmod +x ./shipctl
            - ./shipctl --all --dry-run

  #----------------------------------------------------------------------------
  # Branch Pipelines
  #----------------------------------------------------------------------------
  branches:
    # Main branch - validation only (deploy via custom pipeline)
    main:
      - step:
          <<: *validate-step
          name: Validate (deploy via Run Pipeline)

    master:
      - step:
          <<: *validate-step
          name: Validate (deploy via Run Pipeline)

    # Develop branch - auto deploy to staging
    develop:
      - step:
          <<: *deploy-step
          name: Deploy to Staging
          deployment: staging
          script:
            - apk add --no-cache openssh-client bash git curl
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
            - chmod 600 ~/.ssh/deploy_key
            - ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - chmod +x ./shipctl
            - export SSH_KEY=~/.ssh/deploy_key
            - ./shipctl --all --yes --env staging

  #----------------------------------------------------------------------------
  # Pull Request Pipelines
  #----------------------------------------------------------------------------
  pull-requests:
    '**':
      - step:
          <<: *validate-step
