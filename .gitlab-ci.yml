# shipctl - GitLab CI/CD Pipeline
#
# This pipeline deploys services using shipctl.
# Configure your services in deploy.env or config/services.env before use.
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
#   DOCKERHUB_USERNAME  - DockerHub username
#   DOCKERHUB_PASSWORD  - DockerHub access token (masked)
#   SSH_PRIVATE_KEY     - SSH private key (file type recommended)
#   REMOTE_HOST         - Deployment server IP/hostname
#   REMOTE_USER         - SSH user for deployment

stages:
  - validate
  - deploy
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# Cache configuration for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .docker-cache/

#------------------------------------------------------------------------------
# Validate Configuration
#------------------------------------------------------------------------------
validate:
  stage: validate
  image: alpine:3.19
  script:
    - apk add --no-cache bash shellcheck
    - chmod +x ./shipctl
    # Validate shell script syntax (non-blocking)
    - shellcheck ./shipctl 2>/dev/null || echo "⚠ ShellCheck warnings (review recommended)"
    - |
      if [ -f deploy.env ] || [ -f config/services.env ]; then
        echo "✓ Configuration found"
        ./shipctl --list || echo "⚠ Could not list services"
      else
        echo "⚠ No configuration found"
        echo "  Run: shipctl init"
      fi
  only:
    - merge_requests
    - branches

#------------------------------------------------------------------------------
# Deploy Template (reusable)
#------------------------------------------------------------------------------
.deploy_template: &deploy_template
  stage: deploy
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  before_script:
    # Install dependencies
    - apk add --no-cache openssh-client bash git curl
    
    # Setup SSH with secure host key validation
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - |
      ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts 2>/dev/null
      if [ ! -s ~/.ssh/known_hosts ]; then
        echo "ERROR: Failed to fetch SSH host key for $REMOTE_HOST"
        exit 1
      fi
    
    # Docker login
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    
    # Make deploy script executable
    - chmod +x ./shipctl

#------------------------------------------------------------------------------
# Production Deployments (Manual Trigger)
#------------------------------------------------------------------------------

# Deploy single service - use pipeline variables
deploy:service:
  <<: *deploy_template
  script:
    - export SSH_KEY=~/.ssh/deploy_key
    - |
      if [ -z "$SERVICE_NAME" ]; then
        echo "ERROR: SERVICE_NAME variable not set"
        echo "Run pipeline with SERVICE_NAME variable (e.g., frontend, backend)"
        ./shipctl --list
        exit 1
      fi
    - ./shipctl ${SERVICE_NAME} --yes --env ${DEPLOY_ENV:-production}
  when: manual
  environment:
    name: production
  only:
    - main
    - master

# Deploy all services
deploy:all:
  <<: *deploy_template
  script:
    - export SSH_KEY=~/.ssh/deploy_key
    - ./shipctl --all --yes --env ${DEPLOY_ENV:-production}
  when: manual
  environment:
    name: production
  only:
    - main
    - master

#------------------------------------------------------------------------------
# Staging Deployments (Auto on develop branch)
#------------------------------------------------------------------------------
deploy:staging:
  <<: *deploy_template
  script:
    - export SSH_KEY=~/.ssh/deploy_key
    - |
      if [ -n "$SERVICE_NAME" ]; then
        ./shipctl ${SERVICE_NAME} --yes --env staging
      else
        ./shipctl --all --yes --env staging
      fi
  environment:
    name: staging
  only:
    - develop

#------------------------------------------------------------------------------
# Dry Run (for testing)
#------------------------------------------------------------------------------
dry-run:
  <<: *deploy_template
  script:
    - ./shipctl --all --dry-run
  when: manual
  only:
    - merge_requests
    - branches

#------------------------------------------------------------------------------
# Orchestrator-Specific Deployments (Optional)
# Uncomment and configure based on your infrastructure
#------------------------------------------------------------------------------

# Deploy to Kubernetes
# deploy:kubernetes:
#   <<: *deploy_template
#   script:
#     - export SSH_KEY=~/.ssh/deploy_key
#     - ./shipctl --all --orchestrator kubernetes --yes --env ${DEPLOY_ENV:-production}
#   when: manual
#   environment:
#     name: production-k8s
#   only:
#     - main
#     - master

# Deploy to Docker Swarm
# deploy:swarm:
#   <<: *deploy_template
#   script:
#     - export SSH_KEY=~/.ssh/deploy_key
#     - ./shipctl --all --orchestrator swarm --stack ${STACK_NAME:-myapp} --yes
#   when: manual
#   environment:
#     name: production-swarm
#   only:
#     - main
#     - master

#------------------------------------------------------------------------------
# Cloud Provider Deployments (Optional)
# Uncomment and set required variables for your cloud
#------------------------------------------------------------------------------

# Deploy to AWS ECS
# Required: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, AWS_CLUSTER
# deploy:aws:
#   <<: *deploy_template
#   script:
#     - ./shipctl --all --provider aws --cluster ${AWS_CLUSTER} --yes
#   when: manual
#   environment:
#     name: production-aws
#   only:
#     - main

# Deploy to GCP Cloud Run
# Required: GCP_PROJECT_ID, GCP_SERVICE_KEY
# deploy:gcp:
#   <<: *deploy_template
#   script:
#     - ./shipctl --all --provider gcp --yes
#   when: manual
#   environment:
#     name: production-gcp
#   only:
#     - main

#------------------------------------------------------------------------------
# Release (Triggered on tags)
#------------------------------------------------------------------------------
release:
  stage: release
  image: alpine:3.19
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
  script:
    - apk add --no-cache curl tar gzip
    - |
      VERSION=${CI_COMMIT_TAG#v}
      echo "Creating release for version ${VERSION}"
      
      # Create release archive
      tar -czvf shipctl-${VERSION}.tar.gz \
        --exclude='.git' \
        --exclude='*.tar.gz' \
        .
      
      echo "Archive created: shipctl-${VERSION}.tar.gz"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 week
